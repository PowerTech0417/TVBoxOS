name: TVBox Multi-Build (Universal Optimized)

on:
  workflow_dispatch:
    inputs:
      user_name:
        description: 'GitHub Username'
        required: true
        default: 'q215613905'
        type: string
      repo_name:
        description: 'Repository Name'
        required: true
        default: 'TVBoxOS'
        type: string
      branch_name:
        description: 'Branch Name'
        required: true
        default: 'main'
        type: string
      build_types:
        description: 'Build Type'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mobile
          - tv
      architectures:
        description: 'Architecture'
        required: true
        default: 'universal'
        type: choice
        options:
          - universal
          - arm64
          - arm7
          - separate

  schedule:
    - cron: '0 13 1 * *'

# å…¨å±€çŽ¯å¢ƒå˜é‡ï¼Œç¡®ä¿æ‰€æœ‰ Job éƒ½èƒ½è®¿é—®
env:
  GLOBAL_TAG: "TVBox-${{ github.event.inputs.branch_name || 'main' }}-${{ github.run_id }}"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    
    steps:
      - name: Generate Build Matrix
        id: set-matrix
        run: |
          BUILD_TYPES="${{ github.event.inputs.build_types || 'all' }}"
          ARCHS="${{ github.event.inputs.architectures || 'universal' }}"
          MATRIX_ENTRIES="["
          
          if [ "$BUILD_TYPES" = "all" ]; then
            TYPES=("mobile" "tv")
          else
            TYPES=("$BUILD_TYPES")
          fi
          
          if [ "$ARCHS" = "universal" ]; then
            ARCH_LIST=("universal")
          elif [ "$ARCHS" = "separate" ]; then
            ARCH_LIST=("arm64" "arm7")
          else
            ARCH_LIST=("$ARCHS")
          fi
          
          FIRST=true
          for TYPE in "${TYPES[@]}"; do
            for ARCH in "${ARCH_LIST[@]}"; do
              VARIANT="Release"
              if [[ "$ARCH" == "arm64" ]]; then
                ABI_FILTERS='["arm64-v8a"]'
              elif [[ "$ARCH" == "arm7" ]]; then
                ABI_FILTERS='["armeabi-v7a"]'
              else
                ABI_FILTERS='["arm64-v8a","armeabi-v7a"]'
              fi
              
              if [ "$FIRST" = true ]; then FIRST=false; else MATRIX_ENTRIES="$MATRIX_ENTRIES,"; fi
              MATRIX_ENTRIES="$MATRIX_ENTRIES{\"build_type\":\"$TYPE\",\"architecture\":\"$ARCH\",\"variant\":\"$VARIANT\",\"abi_filters\":$ABI_FILTERS}"
            done
          done
          MATRIX_ENTRIES="$MATRIX_ENTRIES]"
          echo "matrix=$MATRIX_ENTRIES" >> $GITHUB_OUTPUT

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      max-parallel: 4
    
    steps:
      - name: Checkout Workflow Code
        uses: actions/checkout@v4
        
      - name: Clone Source Code
        run: |
          git clone https://github.com/${{ github.event.inputs.user_name }}/${{ github.event.inputs.repo_name }}.git TVBoxOSC
          cd TVBoxOSC
          git checkout ${{ github.event.inputs.branch_name }}
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
          
      - name: Configure ABI Filters
        working-directory: TVBoxOSC
        run: |
          echo "ðŸ”§ Configuration des filtres..."
          ABI_LIST='${{ toJson(matrix.abi_filters) }}'
          CLEAN_ABI=$(echo $ABI_LIST | tr -d '[]" ')
          
          if [ -f "app/build.gradle" ]; then
            sed -i '/abiFilters/d' app/build.gradle
            if [ -n "$CLEAN_ABI" ]; then
               FORMATTED_ABI=$(echo $CLEAN_ABI | sed 's/,/","/g')
               sed -i "s/defaultConfig {/defaultConfig { \n        ndk { abiFilters \"$FORMATTED_ABI\" }/g" app/build.gradle
               echo "âœ… Filtres appliquÃ©s: $CLEAN_ABI"
            fi
          fi

      - name: Build APK
        working-directory: TVBoxOSC
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace --parallel
          
      - name: Process APK Files
        working-directory: TVBoxOSC
        run: |
          mkdir -p output/release
          TAG="${{ env.GLOBAL_TAG }}"
          find app/build/outputs/apk/ -name "*.apk" -type f | while read file; do
            NEW_NAME="TVBox-${{ matrix.build_type }}-${{ matrix.architecture }}-${TAG}.apk"
            cp "$file" "output/release/$NEW_NAME"
          done
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-${{ matrix.build_type }}-${{ matrix.architecture }}
          path: TVBoxOSC/output/release/*.apk

  combine-artifacts:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-apks
      - name: Finalize
        run: |
          mkdir -p final-release
          find all-apks -name "*.apk" -exec cp {} final-release/ \;
          echo "âœ… Fichiers regroupÃ©s avec succÃ¨s."
      - name: Upload Final Bundle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.GLOBAL_TAG }}-Complete
          path: final-release/
