name: TVBox Multi-Build Optimized

on:
  workflow_dispatch:
    inputs:
      user_name:
        description: 'GitHubç”¨æˆ·å'
        required: true
        default: 'q215613905'
        type: string
      repo_name:
        description: 'ä»“åº“å'
        required: true
        default: 'TVBoxOS'
        type: string
      branch_name:
        description: 'åˆ†æ”¯å'
        required: true
        default: 'main'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Workflow Code
        uses: actions/checkout@v4
        
      - name: Clone Source Code
        run: |
          echo "ğŸ“¥ Clonage du dÃ©pÃ´t..."
          git clone https://github.com/${{ github.event.inputs.user_name }}/${{ github.event.inputs.repo_name }}.git TVBoxOSC
          cd TVBoxOSC
          git checkout ${{ github.event.inputs.branch_name }}
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Prepare Build Environment
        working-directory: TVBoxOSC
        run: |
          echo "ğŸ”§ Configuration de l'environnement..."
          echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
          
          PYTHON_PATH=$(which python3)
          echo "chaquopy.python=$PYTHON_PATH" >> gradle.properties
          echo "chaquopy.pip=install" >> gradle.properties
          
          # ä¿®å¤ Python è·¯å¾„
          find . -name "*.gradle" -type f -exec sed -i "s|D:/Programs/Python/Python38/python.exe|$PYTHON_PATH|g" {} \;
          
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            sed -i '1s|.*|#!/usr/bin/env bash|' gradlew
          fi

      - name: Configure Universal Compatibility
        working-directory: TVBoxOSC
        run: |
          echo "ğŸ—ï¸ Optimisation de la compatibilitÃ© TV & Mobile..."
          
          if [ -f "app/build.gradle" ]; then
            # 1. å½»åº•åˆ é™¤åŸæœ‰çš„ abiFilters é™åˆ¶ï¼ˆé˜²æ­¢ç¡¬ç¼–ç å¯¼è‡´çš„é—ªé€€ï¼‰
            sed -i '/abiFilters/d' app/build.gradle
            
            # 2. æ³¨å…¥ Universal ABI æ”¯æŒ (åŒæ—¶åŒ…å« 32ä½ å’Œ 64ä½)
            # è¿™æ˜¯è§£å†³æ‰‹æœºç‰ˆé—ªé€€çš„å…³é”®ï¼Œå› ä¸ºæ‰‹æœºé€šå¸¸éœ€è¦ arm64-v8a
            NDK_CONF='ndk { abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64" }'
            
            # 3. å¼ºåˆ¶é™ä½ minSdkVersion (ç¡®ä¿æ—§ç”µè§†ç›’å…¼å®¹)
            sed -i 's/minSdkVersion [0-9]*/minSdkVersion 19/g' app/build.gradle
            
            # 4. åœ¨ defaultConfig ä¸­æ³¨å…¥é…ç½®
            sed -i "s/defaultConfig {/defaultConfig { $NDK_CONF /g" app/build.gradle
            
            echo "âœ… Configuration de compatibilitÃ© terminÃ©e."
          fi
          
      - name: Build with Gradle
        working-directory: TVBoxOSC
        run: |
          echo "ğŸš€ Lancement de la compilation universelle..."
          # ä½¿ç”¨ assembleRelease æ„å»ºæ‰€æœ‰å˜ä½“
          ./gradlew clean assembleRelease --stacktrace
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-Universal-Compatibility
          path: TVBoxOSC/app/build/outputs/apk/**/*.apk
