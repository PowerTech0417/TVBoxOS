name: TVBox Multi-Build Optimized

on:
  workflow_dispatch:
    inputs:
      user_name:
        description: 'GitHubç”¨æˆ·å'
        required: true
        default: 'q215613905'
        type: string
      repo_name:
        description: 'ä»“åº“å'
        required: true
        default: 'TVBoxOS'
        type: string
      branch_name:
        description: 'åˆ†æ”¯å'
        required: true
        default: 'main'
        type: string
      architectures:
        description: 'æ¶æ„ç±»å‹ (Architecture)'
        required: true
        default: 'universal'
        type: choice
        options:
          - universal
          - arm64-v8a
          - armeabi-v7a

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Workflow Code
        uses: actions/checkout@v4
        
      - name: Clone Source Code
        run: |
          echo "ğŸ“¥ Clonage du dÃ©pÃ´t..."
          git clone https://github.com/${{ github.event.inputs.user_name }}/${{ github.event.inputs.repo_name }}.git TVBoxOSC
          cd TVBoxOSC
          git checkout ${{ github.event.inputs.branch_name }}
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Prepare Build Environment
        working-directory: TVBoxOSC
        run: |
          echo "ğŸ”§ Configuration de l'environnement..."
          echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
          
          PYTHON_PATH=$(which python3)
          echo "chaquopy.python=$PYTHON_PATH" >> gradle.properties
          echo "chaquopy.pip=install" >> gradle.properties
          
          find . -name "*.gradle" -type f -exec sed -i "s|D:/Programs/Python/Python38/python.exe|$PYTHON_PATH|g" {} \;
          
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            sed -i '1s|.*|#!/usr/bin/env bash|' gradlew
          fi

      - name: Configure ABI Filters
        working-directory: TVBoxOSC
        run: |
          echo "ğŸ—ï¸ Configuration des filtres ABI..."
          ARCH_INPUT="${{ github.event.inputs.architectures }}"
          
          if [ -f "app/build.gradle" ]; then
            # æ¸…é™¤åŸæœ‰çš„ abiFilters é™åˆ¶
            sed -i '/abiFilters/d' app/build.gradle
            
            if [ "$ARCH_INPUT" = "universal" ]; then
              echo "âœ… Version Universelle : support arm64-v8a et armeabi-v7a"
              # æ³¨å…¥é€šç”¨æ¶æ„é…ç½®
              sed -i 's/defaultConfig {/defaultConfig { \n        ndk { abiFilters "arm64-v8a", "armeabi-v7a" }/g' app/build.gradle
            else
              echo "âœ… Version spÃ©cifique : $ARCH_INPUT"
              # æ³¨å…¥å•ä¸€æ¶æ„é…ç½®
              sed -i "s/defaultConfig {/defaultConfig { \n        ndk { abiFilters \"$ARCH_INPUT\" }/g" app/build.gradle
            fi
          fi
          
      - name: Build with Gradle
        working-directory: TVBoxOSC
        run: |
          echo "ğŸš€ Lancement de la compilation..."
          ./gradlew clean assembleRelease --stacktrace
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-${{ github.event.inputs.architectures }}-${{ github.run_number }}
          path: TVBoxOSC/app/build/outputs/apk/**/*.apk
