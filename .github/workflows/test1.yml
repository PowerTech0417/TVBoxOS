name: TVBox Multi-Build

on:
  workflow_dispatch:
    inputs:
      user_name:
        description: 'GitHub Username'
        required: true
        default: 'q215613905'
        type: string
      repo_name:
        description: 'Repository Name'
        required: true
        default: 'TVBoxOS'
        type: string
      branch_name:
        description: 'Branch Name'
        required: true
        default: 'main'
        type: string
      build_types:
        description: 'Build Type'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mobile
          - tv
      architectures:
        description: 'Architecture'
        required: true
        default: 'universal'
        type: choice
        options:
          - universal
          - arm64
          - arm7

env:
  GLOBAL_TAG: "TVBox-${{ github.run_number }}"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate Build Matrix
        id: set-matrix
        run: |
          BUILD_TYPES="${{ github.event.inputs.build_types || 'all' }}"
          ARCHS="${{ github.event.inputs.architectures || 'universal' }}"
          MATRIX_ENTRIES="["
          if [ "$BUILD_TYPES" = "all" ]; then TYPES=("mobile" "tv"); else TYPES=("$BUILD_TYPES"); fi
          if [ "$ARCHS" = "universal" ]; then ARCH_LIST=("universal"); else ARCH_LIST=("$ARCHS"); fi
          FIRST=true
          for TYPE in "${TYPES[@]}"; do
            for ARCH in "${ARCH_LIST[@]}"; do
              if [[ "$ARCH" == "arm64" ]]; then ABI='["arm64-v8a"]'; elif [[ "$ARCH" == "arm7" ]]; then ABI='["armeabi-v7a"]'; else ABI='["arm64-v8a","armeabi-v7a"]'; fi
              if [ "$FIRST" = true ]; then FIRST=false; else MATRIX_ENTRIES="$MATRIX_ENTRIES,"; fi
              MATRIX_ENTRIES="$MATRIX_ENTRIES{\"build_type\":\"$TYPE\",\"architecture\":\"$ARCH\",\"abi_filters\":$ABI}"
            done
          done
          MATRIX_ENTRIES="$MATRIX_ENTRIES]"
          echo "matrix=$MATRIX_ENTRIES" >> $GITHUB_OUTPUT

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      max-parallel: 4
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Clone Source
        run: |
          git clone https://github.com/${{ github.event.inputs.user_name }}/${{ github.event.inputs.repo_name }}.git TVBoxOSC
          cd TVBoxOSC
          git checkout ${{ github.event.inputs.branch_name }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Configure ABI
        working-directory: TVBoxOSC
        run: |
          if [ -f "app/build.gradle" ]; then
            sed -i '/abiFilters/d' app/build.gradle
            CLEAN_ABI=$(echo '${{ toJson(matrix.abi_filters) }}' | tr -d '[]" ')
            if [ -n "$CLEAN_ABI" ]; then
              FORMATTED=$(echo $CLEAN_ABI | sed 's/,/","/g')
              sed -i "s@defaultConfig {@defaultConfig { ndk { abiFilters \"$FORMATTED\" }@g" app/build.gradle
            fi
          fi

      - name: Build APK
        working-directory: TVBoxOSC
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace --parallel

      - name: Save APK
        working-directory: TVBoxOSC
        run: |
          mkdir -p output
          find app/build/outputs/apk/ -name "*.apk" -type f -exec cp {} output/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-${{ matrix.build_type }}-${{ matrix.architecture }}
          path: TVBoxOSC/output/*.apk

  combine:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-apks
      - name: Package Final Release
        run: |
          mkdir -p final
          find all-apks -name "*.apk" -exec cp {} final/ \;
      - name: Final Upload
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-Combined-Pack
          path: final/*.apk
