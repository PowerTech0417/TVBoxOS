name: TVBox Build

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      user_name:
        description: 'GitHub用户名'
        required: true
        default: 'q215613905'
        type: string
      repo_name:
        description: '仓库名'
        required: true
        default: 'TVBoxOS'
        type: string
      branch_name:
        description: '分支名'
        required: true
        default: 'main'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Workflow Code
        uses: actions/checkout@v4
        
      - name: Display Inputs
        run: |
          echo "User: ${{ github.event.inputs.user_name }}"
          echo "Repo: ${{ github.event.inputs.repo_name }}"
          echo "Branch: ${{ github.event.inputs.branch_name }}"
          
      - name: Clone Source Code
        run: |
          git clone https://github.com/${{ github.event.inputs.user_name }}/${{ github.event.inputs.repo_name }}.git TVBoxOSC
          cd TVBoxOSC
          git checkout ${{ github.event.inputs.branch_name }}
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Prepare Build Environment
        working-directory: TVBoxOSC
        run: |
          # 创建必要的配置文件
          echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
          
          # 配置 Chaquopy Python 路径
          PYTHON_PATH=$(which python3)
          echo "chaquopy.python=$PYTHON_PATH" >> gradle.properties
          echo "chaquopy.pip=install" >> gradle.properties
          
          # 修复 Windows Python 路径
          find . -name "*.gradle" -type f -exec sed -i "s|D:/Programs/Python/Python38/python.exe|$PYTHON_PATH|g" {} \;
          
          # 修复 gradlew
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            sed -i '1s|.*|#!/usr/bin/env bash|' gradlew
          fi
          
      - name: Build with Gradle
        working-directory: TVBoxOSC
        run: |
          ./gradlew clean assemblerelease --stacktrace
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-APK
          path: TVBoxOSC/app/build/outputs/apk/**/*.apk
