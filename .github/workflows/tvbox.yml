name: TVBox Universal Build

on:
  workflow_dispatch:
    inputs:
      user_name:
        description: 'GitHubç”¨æˆ·å'
        required: true
        default: 'q215613905'
        type: string
      repo_name:
        description: 'ä»“åº“å'
        required: true
        default: 'TVBoxOS'
        type: string
      branch_name:
        description: 'åˆ†æ”¯å'
        required: true
        default: 'main'
        type: string
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mobile
          - tv

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - build_type: 'mobile'
            variant: 'Release'
          - build_type: 'tv'
            variant: 'TvRelease'
    
    steps:
      - name: Checkout Workflow Code
        uses: actions/checkout@v4
        
      - name: Display Build Info
        run: |
          echo "ðŸŽ¯ æž„å»ºé…ç½®:"
          echo "ç±»åž‹: ${{ matrix.build_type }}"
          echo "å˜ä½“: ${{ matrix.variant }}"
          
      - name: Clone Source Code
        run: |
          USER_NAME="${{ github.event.inputs.user_name || 'q215613905' }}"
          REPO_NAME="${{ github.event.inputs.repo_name || 'TVBoxOS' }}"
          BRANCH_NAME="${{ github.event.inputs.branch_name || 'main' }}"
          
          echo "ðŸ“¥ å…‹éš†ä»“åº“: $USER_NAME/$REPO_NAME:$BRANCH_NAME"
          git clone https://github.com/$USER_NAME/$REPO_NAME.git TVBoxOSC
          cd TVBoxOSC
          git checkout $BRANCH_NAME
          
          # èŽ·å–æäº¤ä¿¡æ¯
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format="%cd" --date=format:"%Y%m%d-%H%M")
          
          echo "commit=$COMMIT_HASH" >> $GITHUB_ENV
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_ENV
          echo "tag=TVBox-${COMMIT_DATE}" >> $GITHUB_ENV
          
      - name: Setup Build Environment
        working-directory: TVBoxOSC
        run: |
          echo "ðŸ”§ è®¾ç½®æž„å»ºçŽ¯å¢ƒ..."
          
          # å®‰è£…å¿…è¦å·¥å…·
          apt-get update && apt-get install -y curl unzip zip
          
          # åˆ›å»ºå¿…è¦çš„é…ç½®æ–‡ä»¶
          echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
          
          # é…ç½® gradle.properties
          cat > gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
org.gradle.parallel=true
org.gradle.daemon=true
org.gradle.caching=true
EOF
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Setup Python for Chaquopy
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Configure Chaquopy
        working-directory: TVBoxOSC
        run: |
          echo "ðŸ é…ç½® Chaquopy..."
          
          PYTHON_PATH=$(which python3)
          echo "Python è·¯å¾„: $PYTHON_PATH"
          
          # æ·»åŠ åˆ° gradle.properties
          echo "" >> gradle.properties
          echo "# Chaquopy é…ç½®" >> gradle.properties
          echo "chaquopy.python=$PYTHON_PATH" >> gradle.properties
          
          # ä¿®å¤ Windows è·¯å¾„
          find . -name "*.gradle" -type f -exec sed -i "s|D:/Programs/Python/.*python.exe|$PYTHON_PATH|gi" {} \;
          
          # å®‰è£… Python ä¾èµ–
          python3 -m pip install --upgrade pip
          if [ -f "pyramid/requirements.txt" ]; then
            python3 -m pip install -r pyramid/requirements.txt
          fi
          
      - name: Modify Version Info
        working-directory: TVBoxOSC
        run: |
          echo "âš™ï¸ ä¿®æ”¹ç‰ˆæœ¬ä¿¡æ¯..."
          
          BUILD_TYPE="${{ matrix.build_type }}"
          TAG="${{ env.tag }}"
          
          if [ -f "app/build.gradle" ]; then
            sed -i "/versionName/s/versionName .*/versionName \"${TAG}-${BUILD_TYPE}\"/" app/build.gradle
            echo "âœ… ç‰ˆæœ¬åç§°ä¿®æ”¹ä¸º: ${TAG}-${BUILD_TYPE}"
          fi
          
          # ä¿®æ”¹å…³äºŽé¡µé¢
          if [ -f "app/src/main/res/layout/dialog_about.xml" ]; then
            sed -i "/android:text=/s/=\"[^\"]*\"/=\"${TAG}-${BUILD_TYPE}\\n\\n\"/" app/src/main/res/layout/dialog_about.xml
          fi
          
      - name: Configure Signing
        working-directory: TVBoxOSC
        run: |
          echo "ðŸ” é…ç½®ç­¾å..."
          
          # æ£€æŸ¥å¹¶å¤åˆ¶ç­¾åæ–‡ä»¶
          WORKSPACE_PATH="${{ github.workspace }}"
          KEYSTORE_PATH="$WORKSPACE_PATH/.github/workflows/TVBoxOSC.jks"
          
          if [ -f "$KEYSTORE_PATH" ]; then
            cp "$KEYSTORE_PATH" app/
            
            cat >> gradle.properties << 'EOF'

# ç­¾åé…ç½®
RELEASE_STORE_FILE=./TVBoxOSC.jks
RELEASE_KEY_ALIAS=TVBoxOSC
RELEASE_STORE_PASSWORD=TVBoxOSC
RELEASE_KEY_PASSWORD=TVBoxOSC
EOF
            echo "âœ… ç­¾åé…ç½®å·²æ·»åŠ "
          else
            echo "âš ï¸  ä½¿ç”¨è°ƒè¯•ç­¾å"
          fi
          
      - name: Prepare Gradle Wrapper
        working-directory: TVBoxOSC
        run: |
          echo "ðŸ“¦ å‡†å¤‡ Gradle..."
          
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            sed -i '1s|.*|#!/usr/bin/env bash|' gradlew
            echo "âœ… gradlew å·²ä¿®å¤"
          fi
          
      - name: Build APK
        working-directory: TVBoxOSC
        env:
          ANDROID_HOME: /usr/local/lib/android/sdk
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          echo "ðŸ—ï¸ å¼€å§‹æž„å»º: ${{ matrix.variant }}"
          
          # æ¸…ç†å¹¶æž„å»º
          ./gradlew clean assemblerelease \
            --build-cache \
            --parallel \
            --stacktrace
          
          echo "âœ… æž„å»ºå®Œæˆ"
          
      - name: Process APK Files
        working-directory: TVBoxOSC
        run: |
          echo "ðŸ“¦ å¤„ç† APK æ–‡ä»¶..."
          
          BUILD_TYPE="${{ matrix.build_type }}"
          TAG="${{ env.tag }}"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p output
          
          # æŸ¥æ‰¾ APK æ–‡ä»¶
          APK_FILES=$(find . -name "*.apk" -type f | grep -i release || true)
          
          if [ -n "$APK_FILES" ]; then
            echo "æ‰¾åˆ° APK æ–‡ä»¶:"
            echo "$APK_FILES"
            
            # æŸ¥æ‰¾ universal ç‰ˆæœ¬
            UNIVERSAL_APK=$(echo "$APK_FILES" | grep -i universal | head -1)
            if [ -n "$UNIVERSAL_APK" ]; then
              NEW_NAME="TVBox-${BUILD_TYPE}-universal-${TAG}.apk"
              cp "$UNIVERSAL_APK" "output/$NEW_NAME"
              echo "ðŸ“± Universal ç‰ˆæœ¬: $NEW_NAME"
            else
              # å¦‚æžœæ²¡æœ‰ universalï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ APK
              FIRST_APK=$(echo "$APK_FILES" | head -1)
              if [ -n "$FIRST_APK" ]; then
                NEW_NAME="TVBox-${BUILD_TYPE}-${TAG}.apk"
                cp "$FIRST_APK" "output/$NEW_NAME"
                echo "ðŸ“± é»˜è®¤ç‰ˆæœ¬: $NEW_NAME"
              fi
            fi
          else
            echo "âš ï¸  æœªæ‰¾åˆ° APK æ–‡ä»¶ï¼Œå°è¯•é»˜è®¤ä½ç½®..."
            # å°è¯•é»˜è®¤ä½ç½®
            if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
              cp "app/build/outputs/apk/release/app-release.apk" "output/TVBox-${BUILD_TYPE}-${TAG}.apk"
            elif [ -f "app/build/outputs/apk/tvrelease/app-tvrelease.apk" ]; then
              cp "app/build/outputs/apk/tvrelease/app-tvrelease.apk" "output/TVBox-${BUILD_TYPE}-${TAG}.apk"
            fi
          fi
          
          # æ˜¾ç¤ºè¾“å‡ºæ–‡ä»¶
          echo "ðŸ“ è¾“å‡ºæ–‡ä»¶åˆ—è¡¨:"
          ls -la output/
          
      - name: Create Build Info
        working-directory: TVBoxOSC
        run: |
          echo "ðŸ“‹ åˆ›å»ºæž„å»ºä¿¡æ¯..."
          
          BUILD_TYPE="${{ matrix.build_type }}"
          
          cat > "output/build-info.txt" << EOF
æž„å»ºç±»åž‹: ${BUILD_TYPE}
ç‰ˆæœ¬: ${{ env.tag }}
æäº¤: ${{ env.commit }}
æž„å»ºæ—¶é—´: $(date)
è§¦å‘æ–¹å¼: ${{ github.event_name }}
ä»“åº“: ${{ github.event.inputs.user_name || 'q215613905' }}/${{ github.event.inputs.repo_name || 'TVBoxOS' }}
åˆ†æ”¯: ${{ github.event.inputs.branch_name || 'main' }}
EOF
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-${{ matrix.build_type }}-${{ env.tag }}
          path: TVBoxOSC/output/*
          retention-days: 30
          
      - name: Build Complete
        run: |
          echo "========================================"
          echo "ðŸŽ‰ æž„å»ºå®Œæˆ!"
          echo "========================================"
          echo "ç±»åž‹: ${{ matrix.build_type }}"
          echo "ç‰ˆæœ¬: ${{ env.tag }}"
          echo "æäº¤: ${{ env.commit }}"
          echo "========================================"
