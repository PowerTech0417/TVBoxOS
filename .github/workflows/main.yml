name: TVBox Universal Build

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      user_name:
        description: 'GitHubç”¨æˆ·å'
        required: true
        default: 'q215613905'
        type: string
      repo_name:
        description: 'ä»“åº“å'
        required: true
        default: 'TVBoxOS'
        type: string
      branch_name:
        description: 'åˆ†æ”¯å'
        required: true
        default: 'main'
        type: string
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mobile
          - tv

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - build_type: 'mobile'
            variant: 'Release'
          - build_type: 'tv'
            variant: 'TvRelease'
    
    steps:
      - name: Checkout Workflow Code
        uses: actions/checkout@v4
        
      - name: Display Inputs
        run: |
          echo "User: ${{ github.event.inputs.user_name }}"
          echo "Repo: ${{ github.event.inputs.repo_name }}"
          echo "Branch: ${{ github.event.inputs.branch_name }}"
          echo "Build Type: ${{ matrix.build_type }}"
          echo "Variant: ${{ matrix.variant }}"
          
      - name: Clone Source Code
        run: |
          git clone https://github.com/${{ github.event.inputs.user_name }}/${{ github.event.inputs.repo_name }}.git TVBoxOSC
          cd TVBoxOSC
          git checkout ${{ github.event.inputs.branch_name }}
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format="%cd" --date=format:"%Y%m%d-%H%M")
          echo "commit=$COMMIT_HASH" >> $GITHUB_ENV
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_ENV
          echo "tag=TVBox-${COMMIT_DATE}" >> $GITHUB_ENV
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Prepare Build Environment
        working-directory: TVBoxOSC
        run: |
          # åˆ›å»ºå¿…è¦çš„é…ç½®æ–‡ä»¶
          echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
          
          # é…ç½® gradle.properties
          cat > gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
org.gradle.parallel=true
org.gradle.daemon=true
EOF
          
          # é…ç½® Chaquopy Python è·¯å¾„
          PYTHON_PATH=$(which python3)
          echo "chaquopy.python=$PYTHON_PATH" >> gradle.properties
          echo "chaquopy.pip=install" >> gradle.properties
          
          # ä¿®å¤ Windows Python è·¯å¾„
          find . -name "*.gradle" -type f -exec sed -i "s|D:/Programs/Python/Python38/python.exe|$PYTHON_PATH|g" {} \;
          
          # ä¿®å¤ gradlew
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            sed -i '1s|.*|#!/usr/bin/env bash|' gradlew
          fi
          
      - name: Modify Version Info
        working-directory: TVBoxOSC
        run: |
          # ä¿®æ”¹ç‰ˆæœ¬åç§°
          BUILD_TYPE="${{ matrix.build_type }}"
          TAG="${{ env.tag }}"
          
          if [ -f "app/build.gradle" ]; then
            sed -i "/versionName/s/versionName .*/versionName \"${TAG}-${BUILD_TYPE}\"/" app/build.gradle
            echo "âœ… Version name updated to: ${TAG}-${BUILD_TYPE}"
          fi
          
      - name: Build with Gradle
        working-directory: TVBoxOSC
        run: |
          echo "Building ${{ matrix.variant }} variant..."
          ./gradlew clean assemble${{ matrix.variant }} --stacktrace
          
      - name: Process APK Files
        working-directory: TVBoxOSC
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p output
          
          BUILD_TYPE="${{ matrix.build_type }}"
          TAG="${{ env.tag }}"
          
          # æŸ¥æ‰¾ APK æ–‡ä»¶
          APK_DIR="app/build/outputs/apk/${{ matrix.variant | lower }}"
          
          if [ -d "$APK_DIR" ]; then
            # ä¼˜å…ˆæŸ¥æ‰¾ universal ç‰ˆæœ¬
            UNIVERSAL_APK=$(find "$APK_DIR" -name "*universal*.apk" | head -1)
            if [ -n "$UNIVERSAL_APK" ]; then
              cp "$UNIVERSAL_APK" "output/TVBox-${BUILD_TYPE}-universal-${TAG}.apk"
              echo "âœ… Universal APK: TVBox-${BUILD_TYPE}-universal-${TAG}.apk"
            else
              # å¦‚æœæ²¡æœ‰ universalï¼Œä½¿ç”¨é»˜è®¤ APK
              DEFAULT_APK=$(find "$APK_DIR" -name "*.apk" | head -1)
              if [ -n "$DEFAULT_APK" ]; then
                cp "$DEFAULT_APK" "output/TVBox-${BUILD_TYPE}-${TAG}.apk"
                echo "âœ… Default APK: TVBox-${BUILD_TYPE}-${TAG}.apk"
              fi
            fi
          else
            echo "âŒ APK directory not found: $APK_DIR"
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶
          echo "ğŸ“ Output files:"
          ls -la output/
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-${{ matrix.build_type }}-${{ env.tag }}
          path: TVBoxOSC/output/*.apk
          
      - name: Build Summary
        run: |
          echo "========================================"
          echo "âœ… Build Completed Successfully!"
          echo "========================================"
          echo "Build Type: ${{ matrix.build_type }}"
          echo "Variant: ${{ matrix.variant }}"
          echo "Version: ${{ env.tag }}"
          echo "Commit: ${{ env.commit }}"
          echo "========================================"
